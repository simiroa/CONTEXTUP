# System Architecture

This document provides a detailed technical overview of the **ContextUp** codebase. It serves as a map for developers to understand the project structure, key components, and data flow.

## üèóÔ∏è High-Level Architecture

The system operates as a **Windows Context Menu Extension** that dispatches commands to Python scripts. It employs a **Unified Portable Environment** strategy.

### 1. The Entry Point
*   **Registry**: Windows Registry keys (created by `manage.py`) invoke a command when the user right-clicks a file.
*   **Command**: `python src/core/menu.py <item_id> "%1"`
*   **Dispatcher**: `src/core/menu.py` receives the `item_id` (e.g., `sys_batch_rename`) and the target file path. It then imports and runs the appropriate script from `src/scripts/`.

### 2. Unified Environment
*   **Single Environment**: A standalone, portable Python 3.11 build (IndyGreg) located in `tools/python/`.
*   **Dependencies**: All libraries, including heavy AI frameworks (PyTorch, Rembg, Diffusers) and system tools (Pillow, CustomTkinter), are installed in this single environment.
*   **Benefits**: Zero system dependencies, "Copy-Paste" portability, simplified installation.
*   **Location**: `tools/python/` (Auto-downloaded/extracted by installer).

---

## üìÇ Directory Structure & File Roles

### Root Directory
*   `manage.py`: CLI tool to register/unregister context menu items and run health checks.
*   `ContextUpManager.bat`: Launcher script for the Manager GUI.
*   `install.bat` / `src/scripts/install_contextup.py`: Setup scripts to download the portable Python and install dependencies.
*   `config/menu_config.json`: **Build Artifact (Webpack-style output)**. 
    > [!WARNING]
    > **DO NOT EDIT THIS FILE DIRECTLY.** It is automatically generated from `config/menu_categories/*.json`. Any manual changes here will be overwritten by the Manager or Builder.

### `src/core/` (Core Logic)
*   `menu.py`: **Main Dispatcher**. The single entry point called by the Context Menu. Routes commands to specific scripts.
*   `registry.py`: Handles Windows Registry operations (creating/deleting keys).
*   `config.py`: Loads and parses `menu_config.json`.
*   `logger.py`: Centralized logging configuration.
*   `health.py`: System health check logic.

### `src/scripts/` (Feature Implementations)
*   **System & General**:
    *   `sys_tools.py`: Implements file/folder operations (Move, Clean, Arrange, PDF Merge/Split).
    *   `manager_gui.py`: The main settings and management interface.
    *   `rename_tools.py`: Unified GUI for Batch Rename and Renumbering.
*   **Image**:
    *   `image_tools.py`: Format conversion, Resize (POT), EXIF removal, EXR tools.
    *   `upscale_tools.py`: Wrapper for AI upscaling.
    *   `ai_tools.py`: Wrapper for AI background removal.
    *   `texture_tools.py`: Gemini-powered texture generation.
*   **Video & Audio**:
    *   `video_tools.py`: Video conversion, proxy creation, sequence-to-video (via FFmpeg).
    *   `video_convert_gui.py`: Unified GUI for video operations.
    *   `audio_tools.py`: Audio conversion, volume optimization.
    *   `video_audio_gui.py`: Unified GUI for audio extraction/separation.
    *   `frame_interp_tools.py`: Frame interpolation logic.
    *   `subtitle_tools.py`: Subtitle generation logic.
*   **3D & CAD**:
    *   `blender_tools.py`: Bridge to Blender for mesh conversion and texture extraction.
    *   `mayo_tools.py`: Bridge to Mayo CLI for CAD conversion.
*   **AI Standalone** (Scripts running in Unified Env):
    *   `src/scripts/ai_standalone/bg_removal.py`: Inference code for RMBG-2.0.
    *   `src/scripts/ai_standalone/upscale.py`: Inference code for AI Upscaling.

### `src/utils/` (Shared Utilities)
*   `ai_runner.py`: Formerly Conda bridge, now runs scripts within the same unified environment or subprocess if needed for isolation.
*   `batch_runner.py`: **Debouncing Logic**. Collects multiple process launches into a single batch execution.
*   `progress_gui.py`: **Unified Progress UI**. Thread-safe progress bar with Stop button.
*   `explorer.py`: Utilities to interact with Windows Explorer.
*   `external_tools.py`: Locates external binaries (FFmpeg, Blender, Mayo).
*   `gui.py`: Tkinter helpers.

### 3. Tray Agent System (v2)
*   **Role**: Persistent background process (`src/scripts/tray_agent.py`).
*   **Library**: `pystray` + `Pillow`.
*   **Architecture**:
    *   **Startup**: Uses **Dynamic Port + Handshake File** (`logs/tray_info.json`) to guarantee atomic startup.
    *   **Features**: Handshake verification, Direct Launch of Manager, Module Loading.

---

## üîÑ Key Data Flows

### 1. Context Menu Execution Flow
1.  **User Action**: Right-click -> "ContextUp" -> "Image" -> "Convert Format".
2.  **Windows**: Executes `tools/python/python.exe src/core/menu.py image_format_convert "C:\Path\To\Image.png"`.
3.  **Dispatcher (`menu.py`)**:
    *   Checks `item_id`.
    *   Calls `batch_runner.collect_batch_context()`.
    *   Imports and runs target script.

### 2. AI Task Flow (e.g., Background Removal)
1.  **Dispatcher**: Calls `src/scripts/ai_tools.py`.
2.  **Wrapper**: `ai_tools.py` collects options via GUI.
3.  **Execution**: Calls `src/scripts/ai_standalone/bg_removal.py` directly using the Unified Python Environment.
4.  **Inference**: `bg_removal.py` loads PyTorch model, processes image, saves output.
5.  **UI**: Wrapper updates `BatchProgressGUI`.

---

## üõ†Ô∏è Optimization & Extension Guide

*   **Adding a New Tool**:
    1.  Create script in `src/scripts/`.
    2.  Add entry to `config/menu_categories/*.json` (then rebuild `menu_config.json`).
    3.  Add dispatch logic to `src/core/menu.py`.
    4.  Run `manage.py register`.
*   **Performance**:
    *   `menu.py` imports are lazy.
    *   Heavy libraries are loaded only when specific features are invoked.
*   **Debugging**:
    *   Check `debug.log`.

